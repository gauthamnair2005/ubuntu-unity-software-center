#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
BUILD_DIR="${ROOT_DIR}/build"
BIN_PATH="${BUILD_DIR}/src/unity-software"

if [ ! -x "${BIN_PATH}" ]; then
  echo "unity-software: build output missing. Run 'meson setup build' and 'meson compile -C build'." >&2
  exit 1
fi

DATA_DIR="${BUILD_DIR}/data"
if [ ! -d "${DATA_DIR}" ]; then
  meson compile -C "${BUILD_DIR}" install-sample-data >/dev/null
fi

export GSETTINGS_SCHEMA_DIR="${DATA_DIR}"
export UNITY_SOFTWARE_DATA_DIR="${DATA_DIR}"
export XDG_DATA_DIRS="${ROOT_DIR}/data:${DATA_DIR}:${XDG_DATA_DIRS:-/usr/local/share:/usr/share}"
export UNITY_SOFTWARE_PLUGIN_DIRS="${ROOT_DIR}/plugins:${BUILD_DIR}/plugins"

exec "${BIN_PATH}" "$@"
